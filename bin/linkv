#!/usr/bin/env node

var child_process = require('child_process'),
    async         = require('async'),
    commander     = require('commander'),
    linkv         = require(__dirname + '/../index'),
    pkj           = require(__dirname + '/../package.json');

commander
	.version(pkj.version)
	.option('-c, --copy', 'copy to clipboard (mac only)')
	.option('-t, --html', 'output link as html')
	.parse(process.argv);

if (!commander.args.length) {
	console.error('please enter a url.');
	process.exit(1);
}

var type = null;
if (commander.html) {
	type = 'html';
}

var clipboard = [];

async.forEach(commander.args, function (url, callback) {
	linkv(url, type, function (err, result) {
		if (err) {
			console.error(err);
			process.exit(1);
		}

		console.log(result);
		if (commander.copy) {
			clipboard.push(result);
		}
		callback();
	});
}, function () {
	if (!commander.copy) {
		return;
	}

	child_process.exec(
		'echo "' + clipboard.join('\n') + '" | pbcopy',
		function (err, res) {
			if (err) {
				console.error(err);
				process.exit(1);
			}
			console.log('copied to clipboard.');
		}
	);
});

